<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	
<script>
$( document ).ready(function(){
window.alert("ready!");	
generatesiteid();

	
});
	
	
function generatesiteid(){ //Path to siteIds
	
window.alert("inside Gerenate function");
 var resultsiteid = "";
	 jQuery.ajax({
		 url: 'https://services1.arcgis.com/AVP60cs0Q9PEA8rH/ArcGIS/rest/services/TrafficCameras_Public/FeatureServer/0/query?where=1%3D1&outFields=*&returnGeometry=true&outSR=4326&f=pjson',
		 type: "GET",
		  contentType: "text/plain",
          dataType: "text",
	 success: function( data )
	{
    //window.alert("Data came back is:" + data);
		$("div#databackis").text(data);

		var text = data ;
		var obj = JSON.parse(text);
		//var resultsiteid  = obj["site-id"];
		(function(cb) { var xyz = resultsiteid; cb(xyz); })(getsiteidvalue);
}  ,
		  async: false
});
return resultsiteid;
		
}

var getsiteidvalue = function(xyz) {
googleurl = xyz;
window.alert(xyz);
}

/*START*/
var COC = COC || {};
COC.Transportation = COC.Transportation || {};
COC.Transportation.Roads = COC.Transportation.Roads || {};
COC.Transportation.Roads.TrafficCameras = (function($) {

	/*** MEMBERS ***/
	
	var _arrTrafficCameras = [];
	
	var NUM_CAMS_PER_ROW = 2;
	var NUM_ROWS = 2000;  // 200 is the default for "row limit"
		
	var soapEnv =
		"<soapenv:Envelope xmlns:soapenv='http://schemas.xmlsoap.org/soap/envelope/'> \
			<soapenv:Body> \
				 <GetListItems xmlns='http://schemas.microsoft.com/sharepoint/soap/'> \
					<listName>Traffic Cameras</listName> \
					<viewFields> \
						<ViewFields> \
							<FieldRef Name='ows_Title' /> \
					    </ViewFields> \
					</viewFields> \
					<rowLimit>" + NUM_ROWS + "</rowLimit> \
					<queryOptions> \
						<QueryOptions> \
						</QueryOptions> \
					</queryOptions> \
				</GetListItems> \
			</soapenv:Body> \
		</soapenv:Envelope>";
		
	var TrafficCamera = function(config) {
		return {
			'Quadrants': config.Quadrants,
			'Title': config.Title,
			'Point': config.Point,
			'IsOffline': config.IsOffline,
			'ImageHtml': config.ImageHtml
		};
	};
	
	/*** METHODS ***/
	
	/* public 	Init
	 * return	void
	 **/
	var GetData = function(callback) {
		// TODO: use jquery deferred promise, as well as the newer event types and error handling
		$.ajax({
			url: '/_vti_bin/lists.asmx',
			type: 'post',
			dataType: 'xml',
			data: soapEnv,
			complete: function(xData, status) {
				ParseData(xData, callback);
			},
			contentType: 'text/xml; charset="utf-8"'
		});
	};
	
	var GetTrafficCameras = function() {
		return _arrTrafficCameras;
	};
	
	var ParseData = function(xData, callback) {
		var $xmlResponse = xData.responseXML || xData.responseText;  // sometimes "responseText" is returned instead, possibly with more recent version of jQuery but this is not proven
		var $data = $($xmlResponse).find('z\\:row, row');
		$data.each(function() {
			var $cam = $(this);
			var arrQuadrant = (typeof $cam.attr('ows_Quadrant_x0020_Filter') !== 'undefined') ? $cam.attr('ows_Quadrant_x0020_Filter').toLowerCase().match(/[a-z][a-z]/g) : [];  // match returns an array of quadrants from a multi-val delimited string like this: ";#sw;#se;#"
			var title = $cam.attr('ows_Title');
			if(title.indexOf('. ') >= 0 && title.indexOf('. ') < 5)
				title = title.substr(title.indexOf('. ') + 2);  // remove prefix of: "#. " if one exists. e.g.) "10. Bow Trail / Sarcee Trail NW"
			var IsOffline = ($cam.attr('ows_CocisIsLocationPublic') == "1") ? false : true;  // when the "Is Location Public" field checked then the camera is "online"
			var imageHtml = '';
			var $tmpImage = $($cam.attr('ows_CocisMapLocationDescription')).find('img:first');
			if($tmpImage.length === 1){
				$tmpImage.attr('style','');  // remove styles
				$tmpImage.attr('onerror','this.src="/Transportation/Roads/Scripts/Traffic/TrafficCameras/images/cameraOffline.jpg"');
				imageHtml = $tmpImage[0].outerHTML;
			}

			var trafficCamObj = new TrafficCamera({
				'Quadrants': arrQuadrant,
				'Title': title,
				'Point': $cam.attr('ows_CocisShapePoint'),
				'IsOffline': IsOffline,
				'ImageHtml': imageHtml
			});
			_arrTrafficCameras.push(trafficCamObj);
		});
		callback(_arrTrafficCameras);
	};
	
	/*** FRONT-END HELPERS ***/
	
	var PopulateAccordions = function(arrTrafficCameras) {
		$('#divTrafficCameras').slideDown();				
		$('#divTrafficCameras .accordion-group').each(function() {
			var $trafficCamContainer = $(this).find('.accordion-inner:first .traffic-cam-container:first');
			var i, j;
			for(i = 0; i < arrTrafficCameras.length; i++) {
				try {
					var trafficCam = arrTrafficCameras[i];
					if(!trafficCam.IsOffline) {
						if(typeof $trafficCamContainer.attr('data-quadrant') !== 'undefined') {
							if($trafficCamContainer.attr('data-quadrant').toLowerCase() == trafficCam.Quadrants[0])
								AddCamToAccordion(trafficCam, $trafficCamContainer);
							else {
								if(trafficCam.Title.toLowerCase().search('centre street', 'i') >= 0)
									if(($trafficCamContainer.attr('data-quadrant').toLowerCase() == "ne" && trafficCam.Quadrants[0] == "nw") || ($trafficCamContainer.attr('data-quadrant').toLowerCase() == "nw" && trafficCam.Quadrants[0] == "ne"))
										AddCamToAccordion(trafficCam, $trafficCamContainer);
								if(trafficCam.Title.toLowerCase().search('macleod trail', 'i') >= 0)
									if(($trafficCamContainer.attr('data-quadrant').toLowerCase() == "se" && trafficCam.Quadrants[0] == "sw") || ($trafficCamContainer.attr('data-quadrant').toLowerCase() == "sw" && trafficCam.Quadrants[0] == "se"))
										AddCamToAccordion(trafficCam, $trafficCamContainer);
							}
						} else {
							if(trafficCam.Title.toLowerCase().search($trafficCamContainer.attr('data-regex').toLowerCase(), 'i') >= 0)
								AddCamToAccordion(trafficCam, $trafficCamContainer);
						}
					}
				}
				catch(ex) {}
			}
		});
		AddFloatBreaksToAccordionRows();
	};
	
	var	AddFloatBreaksToAccordionRows = function() {
		$('#divTrafficCameras .traffic-cam-row').each(function() {
			$(this).append('<div style="clear:left;"></div>');
		});
	};
	
	var AddCamToAccordion = function(trafficCam, $trafficCamContainer) {
		// add a row to the container if needed:
		if($trafficCamContainer.find('.traffic-cam-row:last .traffic-cam').length % NUM_CAMS_PER_ROW == 0) {
			$trafficCamContainer.append('<div class="traffic-cam-row"></div>');
		}
					
		// add traffic cam image and title to page
		$trafficCamContainer.find('.traffic-cam-row:last').append('<div class="traffic-cam">' + trafficCam.ImageHtml + '<span>'+ trafficCam.Title +'</span></a>');		
	};

	return {
		GetData: GetData,
		PopulateAccordions: PopulateAccordions,
		GetTrafficCameras: GetTrafficCameras
	};
})(jQuery);
	
	
/*END*/
    


</script>
	
	
</head>
<body>	
<H2>Get Cameras object</H2>
	<div id="databackis"></div>
	</body>
</html>

